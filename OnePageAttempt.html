<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Guitar Tab Reader</title>
  <!-- SoundFont Player CDN -->
  <script src="https://unpkg.com/soundfont-player@0.15.1/dist/soundfont-player.js"></script>
  <!-- VexFlow for fretboard rendering -->
  <script src="https://unpkg.com/vexflow/releases/vexflow-min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    textarea {
      width: 100%;
      height: 120px;
      font-family: monospace;
      margin-bottom: 10px;
      box-sizing: border-box;
    }
    .controls button {
      margin-right: 5px;
      padding: 6px 12px;
      font-size: 14px;
    }
    #fretboard-container {
      margin-top: 20px;
      background: #deb887;
      padding: 10px;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <h1>Guitar Tab Reader</h1>
  <textarea id="tabInput">e|-------------|
B|-------------|
G|-------------|
D|-------------|
A|-------------|
E|-------------|</textarea>
  <div class="controls">
    <button id="playBtn">Play</button>
    <button id="stopBtn">Stop</button>
  </div>
  <div id="fretboard-container"></div>
  <script>
    const { Flow } = Vex;
    const tabInput = document.getElementById('tabInput');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    let intervalId;
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let guitarPlayer;

    // Load SoundFont
    Soundfont.instrument(audioCtx, 'acoustic_guitar_nylon', { gain: 1 }).then(player => {
      guitarPlayer = player;
    });

    // Initialize VexFlow fretboard
    const VF = Vex.Flow;
    const renderer = new VF.Renderer(
      document.getElementById('fretboard-container'),
      VF.Renderer.Backends.SVG
    );
    renderer.resize(800, 200);
    const ctx = renderer.getContext();
    const board = new VF.Fretboard(ctx, {
      width: 760,
      height: 180,
      strings: ['E/4', 'B/3', 'G/3', 'D/3', 'A/2', 'E/2'],
      frets: 15
    });
    board.draw();

    function parseTab(text) {
      const lines = text.trim().split('\n');
      const seq = lines.map(l => l.split('|')[1] || '');
      const notes = [];
      const len = seq[0]?.length || 0;
      for (let pos = 0; pos < len; pos++) {
        seq.forEach((str, s) => {
          const ch = str[pos];
          if (/[0-9]/.test(ch)) {
            let fret = ch;
            const nxt = str[pos+1];
            if (/[0-9]/.test(nxt)) { fret += nxt; pos++; }
            notes.push({ string: 6 - s, fret: parseInt(fret,10) });
          }
        });
      }
      return notes;
    }

    function highlightAndPlay(pos) {
      board.clearFretStyles();
      board.setFretStyle(pos.string - 1, pos.fret, { fillStyle: '#f39c12' });
      board.draw();
      if (guitarPlayer) guitarPlayer.play(board.getNoteString(pos.string - 1, pos.fret));
    }

    playBtn.onclick = () => {
      const notes = parseTab(tabInput.value);
      let i = 0;
      clearInterval(intervalId);
      intervalId = setInterval(() => {
        if (i >= notes.length) return clearInterval(intervalId);
        highlightAndPlay(notes[i]);
        i++;
      }, 500);
    };
    stopBtn.onclick = () => clearInterval(intervalId);
  </script>
</body>
</html>
